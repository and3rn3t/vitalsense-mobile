# Enhanced Performance Lanes for VitalSense
# Append to existing Fastfile or integrate into platform :ios block

platform :ios do
  desc 'Build with maximum performance optimizations'
  lane :build_optimized do
    # Clean derived data for fresh optimized build
    clear_derived_data

    # Build with parallel processing and performance flags
    gym(
      workspace: 'VitalSense.xcworkspace',
      scheme: 'VitalSense',
      configuration: 'Release',
      clean: true,
      output_directory: 'build',
      output_name: 'VitalSense-Optimized',
      archive_path: 'build/VitalSense-Optimized.xcarchive',
      skip_codesigning: false,
      # Performance optimization flags
      xcargs: {
        'COMPILER_INDEX_STORE_ENABLE' => 'NO',
        'OTHER_SWIFT_FLAGS' => '-whole-module-optimization -num-threads 8',
        'SWIFT_WHOLE_MODULE_OPTIMIZATION' => 'YES',
        'GCC_OPTIMIZATION_LEVEL' => 'fast',
        'LLVM_LTO' => 'YES_THIN'
      }.map { |key, value| "-#{key}=#{value}" }.join(' ')
    )

    UI.success('âœ… Optimized build completed successfully!')
  end

  desc 'Performance testing with metrics collection'
  lane :performance_test do
    # Run performance tests with detailed metrics
    run_tests(
      workspace: 'VitalSense.xcworkspace',
      scheme: 'VitalSense',
      configuration: 'Release',
      devices: ['iPhone 15 Pro', 'iPhone 15'],
      testplan: 'VitalSenseTests/VitalSensePerformanceTests.xctestplan',
      code_coverage: true,
      result_bundle: true,
      output_directory: 'fastlane/performance_results',
      xcargs: '-enableCodeCoverage YES -parallel-testing-enabled YES -maximum-concurrent-test-device-destinations 2'
    )

    UI.success('ðŸ“Š Performance tests completed with metrics!')
  end

  desc 'Build cache management and optimization'
  lane :optimize_cache do
    UI.message('ðŸ§¹ Cleaning and optimizing build caches...')

    # Clear derived data
    clear_derived_data

    # Reset Swift Package Manager cache
    sh 'rm -rf ~/Library/Caches/org.swift.swiftpm'
    sh 'rm -rf .build'

    # Clear Xcode archives (keep only latest 5)
    sh 'find ~/Library/Developer/Xcode/Archives -name "*.xcarchive" -type d -exec ls -t1 {} + | tail -n +6 | xargs -r rm -rf'

    # Resolve Swift packages with fresh cache
    sh 'cd .. && xcodebuild -resolvePackageDependencies -workspace VitalSense.xcworkspace -scheme VitalSense'

    UI.success('âœ¨ Build cache optimized!')
  end

  desc 'Build time measurement and analysis'
  lane :build_analysis do |options|
    start_time = Time.now

    UI.message('â±ï¸ Starting build time analysis...')

    # Perform build with timing
    gym(
      workspace: 'VitalSense.xcworkspace',
      scheme: 'VitalSense',
      configuration: options[:configuration] || 'Debug',
      clean: options[:clean] || false,
      skip_archive: true,
      skip_codesigning: true,
      xcargs: '-showBuildTimingSummary'
    )

    end_time = Time.now
    build_duration = end_time - start_time

    # Log results
    UI.success("ðŸŽ¯ Build completed in #{build_duration.round(2)} seconds")

    # Save metrics for tracking
    File.write('build_metrics.log', "#{Time.now}: #{build_duration.round(2)}s\n", mode: 'a')

    build_duration
  end

  desc 'Memory and performance profiling'
  lane :profile_performance do
    UI.message('ðŸ” Starting performance profiling...')

    # Build for profiling
    gym(
      workspace: 'VitalSense.xcworkspace',
      scheme: 'VitalSense',
      configuration: 'Release',
      skip_archive: true,
      xcargs: '-enableAddressSanitizer NO -enableUndefinedBehaviorSanitizer NO'
    )

    # Run with Instruments if available
    if sh('which instruments', log: false).length > 0
      UI.message('Running Instruments Time Profiler...')
      sh 'instruments -t "Time Profiler" -l 60000 build/VitalSense.app || true'
    else
      UI.important('Instruments not available, skipping automated profiling')
    end

    UI.success('ðŸ“ˆ Performance profiling completed!')
  end

  desc 'Health monitoring build - optimized for real-time gait analysis'
  lane :build_health_monitoring do
    UI.message('ðŸ’“ Building health monitoring optimized version...')

    # Specialized build for health monitoring with gait analysis optimizations
    gym(
      workspace: 'VitalSense.xcworkspace',
      scheme: 'VitalSense',
      configuration: 'Release',
      clean: true,
      output_directory: 'build',
      output_name: 'VitalSense-HealthMonitoring',
      xcargs: {
        # Core Motion optimizations
        'MTL_FAST_MATH' => 'YES',
        'GCC_UNROLL_LOOPS' => 'YES',
        'GCC_VECTORIZE_LOOPS' => 'YES',
        # Memory optimizations for real-time processing
        'SWIFT_DETERMINISTIC_HASHING' => 'YES',
        'SWIFT_REFLECTION_METADATA_LEVEL' => 'minimal',
        # Battery optimization flags
        'GCC_FAST_OBJC_DISPATCH' => 'YES',
        'GCC_STRICT_ALIASING' => 'YES'
      }.map { |key, value| "-#{key}=#{value}" }.join(' ')
    )

    UI.success('ðŸ’ª Health monitoring build optimized for real-time gait analysis!')
  end

  desc 'Complete performance CI pipeline'
  lane :performance_ci do
    UI.message('ðŸš€ Starting complete performance CI pipeline...')

    # Step 1: Optimize cache
    optimize_cache

    # Step 2: Run linting
    lint

    # Step 3: Performance tests
    performance_test

    # Step 4: Build analysis
    debug_time = build_analysis(configuration: 'Debug', clean: false)
    release_time = build_analysis(configuration: 'Release', clean: true)

    # Step 5: Optimized health monitoring build
    build_health_monitoring

    # Step 6: Performance profiling
    profile_performance

    # Report summary
    UI.success('ðŸŽ‰ Performance CI completed successfully!')
    UI.message("ðŸ“Š Build Times - Debug: #{debug_time.round(2)}s, Release: #{release_time.round(2)}s")
  end

  desc 'Watch app performance optimization'
  lane :optimize_watch_build do
    UI.message('âŒš Optimizing Watch app build...')

    gym(
      workspace: 'VitalSense.xcworkspace',
      scheme: 'VitalSenseWatch Watch App',
      configuration: 'Release',
      clean: true,
      output_directory: 'build',
      output_name: 'VitalSenseWatch-Optimized',
      xcargs: {
        # Watch-specific optimizations
        'SWIFT_OPTIMIZATION_LEVEL' => '-Osize',  # Size optimization for watch
        'DEAD_CODE_STRIPPING' => 'YES',
        'GCC_OPTIMIZATION_LEVEL' => 's',  # Size over speed for watch
        'STRIP_INSTALLED_PRODUCT' => 'YES'
      }.map { |key, value| "-#{key}=#{value}" }.join(' ')
    )

    UI.success('âŒš Watch app build optimized!')
  end
end
